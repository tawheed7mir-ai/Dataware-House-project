/********************************************************************************************
 ü•à SILVER LAYER | DATA CLEANING & STANDARDIZATION
 -------------------------------------------------------------------------------------------
 üìå Description:
   The Silver Layer is the *cleansed and standardized zone* of the data warehouse.
   It transforms raw Bronze Layer data into consistent, validated, and deduplicated tables.
   This data is now ready for analytical modeling in the Gold Layer.

 üìÇ Purpose:
   - Clean and standardize customer, product, and sales data.
   - Remove duplicates and retain the most recent record.
   - Normalize categorical data (e.g., gender, status).
   - Prepare data for business consumption in the Gold Layer.

 ‚öôÔ∏è Key Transformations:
   - TRIM() to remove leading/trailing spaces.
   - CASE and UPPER() for categorical standardization.
   - ROW_NUMBER() window function for deduplication.
   - ON DUPLICATE KEY UPDATE for incremental upserts.

 üß† Next Step:
   Data from Silver ‚Üí Gold Layer for analytics, reporting, and BI dashboards.

 Author     : Tawheed Mir
 Database   : MySQL
 Layer Type : Silver (Clean Zone)
********************************************************************************************/

-- CREATE DATABASE silver;
-- USE silver;

-- Create cleaned customer info table
CREATE TABLE IF NOT EXISTS silver.crm_cust_info_silver (
    cst_id INT PRIMARY KEY,
    cst_key VARCHAR(50),
    cst_firstname VARCHAR(50),
    cst_lastname VARCHAR(50),
    cst_marital_status VARCHAR(20),
    cst_gndr VARCHAR(10),
    cst_create_date DATE
);

-- Transformation & data insertion
INSERT INTO silver.crm_cust_info_silver (
    cst_id,
    cst_key,
    cst_firstname,
    cst_lastname,
    cst_marital_status,
    cst_gndr,
    cst_create_date
)
SELECT
    cst_id,
    cst_key,
    TRIM(cst_firstname) AS cst_firstname,
    TRIM(cst_lastname) AS cst_lastname,
    cst_marital_status,
    CASE
        WHEN UPPER(TRIM(cst_gndr)) = 'F' THEN 'Female'
        WHEN UPPER(TRIM(cst_gndr)) = 'M' THEN 'Male'
        ELSE 'NA'
    END AS cst_gndr,
    cst_create_date
FROM (
    SELECT *,
           ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_date DESC) AS flag_last
    FROM bronze.crm_cust_info
) t
WHERE flag_last = 1



/******************************************************************************************
 ü•à SILVER LAYER - CRM SALES DETAILS
 PURPOSE:
    This script creates and transforms the CRM Sales Details table 
    from the Bronze layer into the Silver layer in a MySQL Data Warehouse.

    üß© Bronze ‚Üí Silver Transformation Summary:
      - Converts raw INT date values (YYYYMMDD) to DATE datatype
      - Cleans invalid or malformed date entries
      - Fixes incorrect sales and price values
      - Ensures all columns are consistent and ready for analytics

******************************************************************************************/

-- Step 1Ô∏è‚É£: Create the Silver database (if not already exists)
CREATE DATABASE IF NOT EXISTS silver;
USE silver;

-- Step 2Ô∏è‚É£: Create the Silver table for cleaned Sales Details
CREATE TABLE IF NOT EXISTS crm_sales_details_silver (
    sls_ord_num VARCHAR(100),
    sls_prd_key VARCHAR(50),
    sls_cust_id INT,
    sls_order_dt DATE,
    sls_ship_dt DATE,
    sls_due_dt DATE,
    sls_sales INT,
    sls_quantity INT,
    sls_price INT
);

-- Step 3Ô∏è‚É£: Transform and insert clean data from Bronze layer
INSERT INTO silver.crm_sales_details_silver (
    sls_ord_num,
    sls_prd_key,
    sls_cust_id,
    sls_order_dt,
    sls_ship_dt,
    sls_due_dt,
    sls_sales,
    sls_quantity,
    sls_price
)
SELECT 
    sls_ord_num,
    sls_prd_key,
    sls_cust_id,

    -- ‚úÖ Clean & Convert Order Date
    CASE  
        WHEN sls_order_dt = 0 OR LENGTH(sls_order_dt) != 8 THEN NULL
        ELSE STR_TO_DATE(CAST(sls_order_dt AS CHAR), '%Y%m%d')
    END AS sls_order_dt,

    -- ‚úÖ Clean & Convert Ship Date
    CASE  
        WHEN sls_ship_dt = 0 OR LENGTH(sls_ship_dt) != 8 THEN NULL
        ELSE STR_TO_DATE(CAST(sls_ship_dt AS CHAR), '%Y%m%d')
    END AS sls_ship_dt,

    -- ‚úÖ Clean & Convert Due Date
    CASE  
        WHEN sls_due_dt = 0 OR LENGTH(sls_due_dt) != 8 THEN NULL
        ELSE STR_TO_DATE(CAST(sls_due_dt AS CHAR), '%Y%m%d')
    END AS sls_due_dt,

    -- ‚úÖ Fix incorrect sales values
    CASE 
        WHEN sls_sales IS NULL OR sls_sales != sls_quantity * ABS(sls_price)
        THEN sls_quantity * ABS(sls_price)
        ELSE sls_sales 
    END AS sls_sales,

    -- ‚úÖ Quantity remains as-is
    sls_quantity,

    -- ‚úÖ Fix invalid or negative prices
    CASE 
        W


